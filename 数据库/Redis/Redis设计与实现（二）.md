### Redis设计与实现（二）

#### 一、跳跃表

![](E:\读书笔记\readingNotes\Redis\img\a.png)

如图所示，由一个单链表扩展成多层链表就是跳跃表了。

给每个节点设一个表示“层”的指针数组，指向同层次的下一个节点，也就是说同一层即为一个链表。

每一层的层数是随机的，随机策略类似为能连续扔多少次硬币都是正面，这也就使层数平均在logN层。

又可以知道高层指向的节点的距离肯定大于等于低层，所以查询策略是：

- 先对层进行二分处理，找一个小于等于查询数的，然后”跳跃“过去，重复这个步骤。。

插入和删除操作？

#### 二、持久化

1. RDB（即快照）：用来恢复快
   - save命令：阻塞服务器进程，直到将数据库状态转化成RDB文件
   - bgsave命令：fork()让子进程执行持久化
   - 配置文件自动间隔性保存：save 900 1（在距离上一次保存900s内，至少执行了1次写入）
   - 上面的由服务器周期性（每隔100ms）操作函数serverCron检查并执行

2. AOF（即日志）

   - 直接保存了被执行的写命令

   - 执行过程：

     追加命令到缓冲区aof_buf，然后再根据设置写入到磁盘中

     同步保证：操作系统写入数据有时会先将数据存入其缓冲区，这里我们使用fsync和fdatasync强制操作系统立即写入磁盘

   - AOF重写：防止AOF文件内存日益增长，而**根据当前数据库状态**对其进行重写

